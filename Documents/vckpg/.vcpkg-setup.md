# vcpkg 設置指南

本文檔說明如何將 Campfire 從 git submodules 遷移到 vcpkg 包管理器。

## 為什麼使用 vcpkg？

✅ **優點**:
- 統一的跨平台包管理（Windows/Linux/macOS）
- 自動處理依賴關係
- 更容易更新和維護依賴版本
- 減少倉庫大小（不需要 submodules）
- 更快的 clone 速度
- 二進制緩存支持

⚠️ **缺點**:
- 需要額外安裝 vcpkg
- 某些自定義庫可能不可用（如 RuntimeCompiledCPlusPlus）

## 安裝 vcpkg

### Windows

```powershell
# 1. Clone vcpkg
git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
cd C:\vcpkg

# 2. 執行 bootstrap 腳本
.\bootstrap-vcpkg.bat

# 3. （可選）設置環境變量
[System.Environment]::SetEnvironmentVariable('VCPKG_ROOT', 'C:\vcpkg', 'User')
```

### Linux

```bash
# 1. Clone vcpkg
git clone https://github.com/microsoft/vcpkg.git ~/vcpkg
cd ~/vcpkg

# 2. 執行 bootstrap 腳本
./bootstrap-vcpkg.sh

# 3. （可選）設置環境變量
echo 'export VCPKG_ROOT=~/vcpkg' >> ~/.bashrc
source ~/.bashrc
```

## 在 Campfire 中使用 vcpkg

### 方法 1: CMake 命令行（推薦）

```powershell
# Windows
cmake -B Build -G "Visual Studio 17 2022" -A x64 `
  -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake

cmake --build Build --config Release
```

```bash
# Linux
cmake -B build \
  -DCMAKE_TOOLCHAIN_FILE=~/vcpkg/scripts/buildsystems/vcpkg.cmake

cmake --build build --config Release
```

### 方法 2: 環境變量

```powershell
# Windows (永久設置)
[System.Environment]::SetEnvironmentVariable(
  'CMAKE_TOOLCHAIN_FILE', 
  'C:\vcpkg\scripts\buildsystems\vcpkg.cmake', 
  'User'
)
```

```bash
# Linux (添加到 ~/.bashrc)
export CMAKE_TOOLCHAIN_FILE=~/vcpkg/scripts/buildsystems/vcpkg.cmake
```

然後正常使用 CMake：

```bash
cmake -B build -G "Visual Studio 17 2022" -A x64
cmake --build build --config Release
```

## 遷移步驟

### 1. 備份當前配置

```bash
cp Vendor/CMakeLists.txt Vendor/CMakeLists.txt.old
```

### 2. 切換到 vcpkg 版本

```bash
cp Vendor/CMakeLists.txt.vcpkg Vendor/CMakeLists.txt
```

### 3. 安裝依賴

vcpkg 會在首次配置時自動安裝 `vcpkg.json` 中列出的所有依賴：

```powershell
cmake -B Build -G "Visual Studio 17 2022" -A x64 `
  -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake
```

第一次運行會下載和編譯所有依賴，可能需要 20-40 分鐘。

### 4. （可選）手動安裝依賴

如果您想提前安裝依賴：

```bash
# 安裝所有依賴
vcpkg install

# 或單獨安裝
vcpkg install assimp:x64-windows
vcpkg install spdlog:x64-windows
vcpkg install bullet3:x64-windows
# ... 等等
```

## vcpkg.json 說明

```json
{
  "dependencies": [
    {
      "name": "assimp",
      "version>=": "5.4.3"  // 確保最低版本
    },
    {
      "name": "spdlog",
      "version>=": "1.16.0",
      "features": ["fmt-external"]  // 使用外部 fmt
    }
  ]
}
```

## 依賴對照表

| 依賴庫 | vcpkg 可用 | 處理方式 |
|--------|------------|----------|
| assimp | ✅ | vcpkg |
| bullet3 | ✅ | vcpkg |
| glfw | ✅ | vcpkg (glfw3) |
| glm | ✅ | vcpkg |
| imgui | ✅ | vcpkg |
| spdlog | ✅ | vcpkg |
| fmt | ✅ | vcpkg (bundled with spdlog) |
| nlohmann-json | ✅ | vcpkg |
| entt | ✅ | vcpkg |
| lua | ✅ | vcpkg |
| stb | ✅ | vcpkg |
| Vulkan | ✅ | vcpkg (headers only) |
| freetype | ✅ | vcpkg（可選） |
| glad | ❌ | 保持本地源碼 |
| tracy | ❌ | 保持本地源碼 |
| fmod | ❌ | 保持本地（專有） |
| font-awesome-5 | ❌ | 保持本地 |
| **RuntimeCompiledCPlusPlus** | ❌ | **保持 git submodule** |

## RuntimeCompiledCPlusPlus 處理

由於 RuntimeCompiledCPlusPlus 不在 vcpkg 中，我們保持它為 git submodule：

```bash
# 保持 RuntimeCompiledCPlusPlus submodule
git submodule update --init --recursive Vendor/RuntimeCompiledCPlusPlus
```

## CI/CD 更新

更新 GitHub Actions 工作流以使用 vcpkg：

```yaml
# .github/workflows/windows-build.yml
- name: Setup vcpkg
  uses: lukka/run-vcpkg@v11
  with:
    vcpkgGitCommitId: 'c8696863d371ab7f46545de4e661c3f42d5f5b16'

- name: Configure CMake
  run: |
    cmake -B build -G "Visual Studio 17 2022" -A x64 `
      -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake

- name: Build
  run: cmake --build build --config Release
```

## 常見問題

### Q: vcpkg 安裝很慢怎麼辦？

A: 使用二進制緩存：

```bash
# 啟用 vcpkg 的二進制緩存
vcpkg install --x-binarysource=clear;nuget,GitHub,readwrite
```

### Q: 如何更新依賴版本？

A: 更新 `vcpkg.json` 中的版本號：

```json
{
  "name": "assimp",
  "version>=": "5.5.0"  // 更新版本
}
```

然後重新配置：

```bash
rm -rf build/vcpkg_installed
cmake -B build -DCMAKE_TOOLCHAIN_FILE=...
```

### Q: 可以混合使用 vcpkg 和 submodules 嗎？

A: 可以！我們的方案就是這樣：
- 大部分庫通過 vcpkg 管理
- RuntimeCompiledCPlusPlus 保持為 submodule
- 一些專有庫（fmod）保持本地

## 建議的工作流程

1. **新開發者**:
   ```bash
   git clone https://github.com/danhuynh0803/Campfire
   cd Campfire
   git submodule update --init --recursive Vendor/RuntimeCompiledCPlusPlus
   cmake -B build -DCMAKE_TOOLCHAIN_FILE=~/vcpkg/scripts/buildsystems/vcpkg.cmake
   ```

2. **CI/CD**:
   使用 `lukka/run-vcpkg` action 自動處理 vcpkg

3. **更新依賴**:
   修改 `vcpkg.json`，vcpkg 會自動更新

## 回退到 submodules

如果需要回退：

```bash
cp Vendor/CMakeLists.txt.old Vendor/CMakeLists.txt
git submodule update --init --recursive
```

---

*最後更新：2025年11月9日*

